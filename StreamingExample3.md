<Initial_Streaming_Response>
Let me provide a comprehensive analysis of the credit performance based on the financial documents.

The credit performance shows some concerning trends with gradually deteriorating metrics across multiple indicators, though the deterioration appears managed and orderly rather than severe:

1. Loan Growth and Quality:
- Total gross loans have grown steadily from $42,000M in 2024Q1 to $45,000M in 2025Q1, representing healthy growth of 7.1%
- However, this growth has been accompanied by increasing credit stress indicators

2. Credit Quality Indicators:
- Non-performing assets (NPAs) have steadily increased from $350M to $390M over five quarters
- The allowance for loan losses has grown from $350M to $390M, matching the NPA growth
- Non-accrual loans have increased from $260M to $290M
- Past due loans (90+ days) have risen from $120M to $135M

3. Loss Recognition:
- Net charge-offs have shown an upward trend, increasing from $25M to $32M
- The recovery rate has remained relatively stable at around $5-6M per quarter
- Provision for credit losses has increased each quarter, from $40M to $60M, suggesting management expects continued credit deterioration

Let me generate some visualizations to better illustrate these trends.
</Initial_Streaming_Response>

<Post_Visualization_Streaming_Response>
Let me provide a comprehensive analysis of the credit performance based on the financial documents.
The
Let me provide a comprehensive analysis of the credit performance based on the financial documents. The
</Post_Visualization_Streaming_Response>

<JavaScript_Console_Output>
[Log] Upload progress: 100.00%, Stage: Document ready
[Log] Document verification completed: – {metadata: Object, contentType: "integrated_financial_report", extractionTimestamp: "2025-06-20T04:36:22.741Z", …}
{metadata: Object, contentType: "integrated_financial_report", extractionTimestamp: "2025-06-20T04:36:22.741Z", periods: ["2024Q1", "2024Q2", "2024Q3", "2024Q4", "2025Q1"], extractedData: Object, …}Object
[Log] Associating document df8f8d30-5fd6-4378-a99b-0393df092f3c with conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34
[Log] Sending POST request to http://localhost:8000/api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/document/df8f8d30-5fd6-4378-a99b-0393df092f3c
[Log] Document df8f8d30-5fd6-4378-a99b-0393df092f3c added to conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34
[Log] Document successfully associated with conversation
[Log] [Fast Refresh] rebuilding
[Log] PDFViewer unmounting, cleaning up resources
[Log] Sending GET request to http://localhost:8000/api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/citations
[Log] [Fast Refresh] done in 232ms
[Log] [Fast Refresh] done in 325ms
[Log] Deprecated API usage: The `enhanceTextSelection` functionality will be removed in the future. (x3)
[Error] Source Map loading errors (x2)
[Error] Failed to load resource: the server responded with a status of 404 (Not Found) (types.js.map, line 0)
[Error] Failed to load resource: the server responded with a status of 404 (Not Found) (types.js.map, line 0)
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] PDFViewer unmounting, cleaning up resources
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Submit conditions: useStreaming=true, conversationId=c7217cb0-a35d-4cc6-aa65-1a024155eb34, isConnected=true
[Log] Using WebSocket streaming for message submission
[Log] Checking 2 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 2 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Updating with preserved initial content (104 chars)
[Log] Backend protecting content - maintaining frontend streaming text (0 chars) (x87)
[Log] Message complete for null, fetching complete message from database
[Log] HTTP fallback: Message complete for ea159694-892b-4a6a-b8eb-d8ac9cd19f21, fetching from database
[Log] Sending GET request to http://localhost:8000/api/conversation/message/ea159694-892b-4a6a-b8eb-d8ac9cd19f21
[Log] Received HTTP message with 0 analysis blocks
[Log] Streaming message update: – {id: "ea159694-892b-4a6a-b8eb-d8ac9cd19f21", sessionId: "c7217cb0-a35d-4cc6-aa65-1a024155eb34", timestamp: "2025-06-20T04:37:07.665061Z", …}
{id: "ea159694-892b-4a6a-b8eb-d8ac9cd19f21", sessionId: "c7217cb0-a35d-4cc6-aa65-1a024155eb34", timestamp: "2025-06-20T04:37:07.665061Z", role: "assistant", content: "Let me provide a comprehensive analysis of the cre…erformance based on the financial documents.↵↵The", …}Object
[Log] Checking 3 messages for cumulative visualization data...
[Log] Examining assistant message 2: – "ID: ea159694-892b-4a6a-b8eb-d8ac9cd19f21" – "Has 4 analysis blocks"
[Log] Found 4 analysis blocks in message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
[Log] Analysis blocks structure: – "{↵  \"id\": \"084d1954-6bd7-4500-a02f-ed76bafc06a6\",↵  \"block_type\": \"chart\",↵  \"title\": \"Credit Quality Trends\",↵  \"content\": {↵  …"
"{
  \"id\": \"084d1954-6bd7-4500-a02f-ed76bafc06a6\",
  \"block_type\": \"chart\",
  \"title\": \"Credit Quality Trends\",
  \"content\": {
    \"chartType\": \"line\",
    \"config\": {
      \"title\": \"Credit Quality Tr..."
[Log] Processing analysis block 0: type=chart, title=Credit Quality Trends
[Log] Found direct chart data in block 0: line
[Log] Chart data structure: – {hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], …}
{hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], dataLength: 5, sampleData: Object}Object
[Log] Processing analysis block 1: type=table, title=Credit Performance Metrics
[Log] Found direct table data in block 1: detailed
[Log] Processing analysis block 2: type=metric, title=NPAs to Total Loans
[Log] Found metric block 2: NPAs to Total Loans
[Log] Processing analysis block 3: type=metric, title=Reserve Coverage Ratio
[Log] Found metric block 3: Reserve Coverage Ratio
[Log] Returning cumulative visualization data from analysis_blocks: 1 charts, 1 tables, 2 metrics
[Log] Checking 3 messages for cumulative visualization data...
[Log] Examining assistant message 2: – "ID: ea159694-892b-4a6a-b8eb-d8ac9cd19f21" – "Has 4 analysis blocks"
[Log] Found 4 analysis blocks in message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
[Log] Analysis blocks structure: – "{↵  \"id\": \"084d1954-6bd7-4500-a02f-ed76bafc06a6\",↵  \"block_type\": \"chart\",↵  \"title\": \"Credit Quality Trends\",↵  \"content\": {↵  …"
"{
  \"id\": \"084d1954-6bd7-4500-a02f-ed76bafc06a6\",
  \"block_type\": \"chart\",
  \"title\": \"Credit Quality Trends\",
  \"content\": {
    \"chartType\": \"line\",
    \"config\": {
      \"title\": \"Credit Quality Tr..."
[Log] Processing analysis block 0: type=chart, title=Credit Quality Trends
[Log] Found direct chart data in block 0: line
[Log] Chart data structure: – {hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], …}
{hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], dataLength: 5, sampleData: Object}Object
[Log] Processing analysis block 1: type=table, title=Credit Performance Metrics
[Log] Found direct table data in block 1: detailed
[Log] Processing analysis block 2: type=metric, title=NPAs to Total Loans
[Log] Found metric block 2: NPAs to Total Loans
[Log] Processing analysis block 3: type=metric, title=Reserve Coverage Ratio
[Log] Found metric block 3: Reserve Coverage Ratio
[Log] Returning cumulative visualization data from analysis_blocks: 1 charts, 1 tables, 2 metrics
[Log] ChartRenderer - Data received: – {chartType: "line", hasData: true, dataLength: 5, …}
{chartType: "line", hasData: true, dataLength: 5, hasConfig: true, hasChartConfig: true, …}Object
[Log] ChartRenderer - Data received: – {chartType: "line", hasData: true, dataLength: 5, …}
{chartType: "line", hasData: true, dataLength: 5, hasConfig: true, hasChartConfig: true, …}Object
[Log] LineChart - Debug Info: – {chartType: "line", hasConfig: true, hasChartConfig: true, …}
{chartType: "line", hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], dataLength: 5, …}Object
[Log] LineChart - Final render data: – {processedDataLength: 5, processedDataFirst: Object, metricKeys: ["npa", "nonaccrual", "pastdue"], …}
{processedDataLength: 5, processedDataFirst: Object, metricKeys: ["npa", "nonaccrual", "pastdue"], categoryKey: "period", linesCount: 3}Object
[Log] LineChart - Debug Info: – {chartType: "line", hasConfig: true, hasChartConfig: true, …}
{chartType: "line", hasConfig: true, hasChartConfig: true, chartConfigKeys: ["npa", "nonaccrual", "pastdue"], dataLength: 5, …}Object
[Log] LineChart - Final render data: – {processedDataLength: 5, processedDataFirst: Object, metricKeys: ["npa", "nonaccrual", "pastdue"], …}
{processedDataLength: 5, processedDataFirst: Object, metricKeys: ["npa", "nonaccrual", "pastdue"], categoryKey: "period", linesCount: 3}Object
[Log] Sending POST request to http://localhost:8000/api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/generate-followups?limit=3
[Log] Sending POST request to http://localhost:8000/api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/generate-followups?limit=3
</JavaScript_Console_Output>

<Backend_Logs>
(venv) alexcardell@Alexs-MBP backend % cd /Users/alexcardell/AlexCoding_Local/cfin/backend && PYTHONPATH=$PYTHONPATH:/Users/alexcardell/AlexCoding_Local/cfin/backend python -m uvicorn app.main:app --reload --port 8000        
INFO:     Will watch for changes in these directories: ['/Users/alexcardell/AlexCoding_Local/cfin/backend']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [78440] using StatReload
INFO:root:Loaded environment variables from /Users/alexcardell/AlexCoding_Local/cfin/.env
INFO:root:ANTHROPIC_API_KEY loaded: sk-ant-a...TQAA
INFO:app.main:CORS: Allowing origins: ['http://localhost:3000', 'http://localhost:3001', 'http://localhost:3002', 'http://localhost:3003', 'http://127.0.0.1:3000', 'http://127.0.0.1:3001', 'http://127.0.0.1:3002', 'http://127.0.0.1:3003', 'http://127.0.0.1:49937', 'http://127\\.0\\.0\\.1:\\d+', 'http://127.0.0.1:64142']
INFO:     Started server process [78442]
INFO:     Waiting for application startup.
INFO:app.main:Initializing database...
INFO:utils.init_db:Creating database tables...
INFO:utils.init_db:Database tables created successfully.
INFO:utils.init_db:Default user already exists.
INFO:utils.init_db:Database initialization completed successfully.
INFO:app.main:Database initialization completed successfully
INFO:     Application startup complete.
INFO:     127.0.0.1:63881 - "OPTIONS /api/conversation HTTP/1.1" 200 OK
INFO:     127.0.0.1:63882 - "OPTIONS /api/conversation HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.conversation:Created conversation: 9c62dc64-59cb-4f8d-b3c6-8acd6a9714b7 for user: default-user
INFO:app.routes.conversation:Created conversation: c7217cb0-a35d-4cc6-aa65-1a024155eb34 for user: default-user
INFO:     127.0.0.1:63881 - "POST /api/conversation HTTP/1.1" 201 Created
INFO:     127.0.0.1:63882 - "POST /api/conversation HTTP/1.1" 201 Created
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63881 - "GET /api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34 HTTP/1.1" 200 OK
INFO:app.routes.websocket:WebSocket endpoint called for conversation: c7217cb0-a35d-4cc6-aa65-1a024155eb34, user: default-user
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     ('127.0.0.1', 63882) - "WebSocket /ws/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34" [accepted]
INFO:app.routes.websocket:WebSocket connected: default-user_c7217cb0-a35d-4cc6-aa65-1a024155eb34_1750394175942
INFO:app.routes.websocket:WebSocket connection established for conversation: c7217cb0-a35d-4cc6-aa65-1a024155eb34
INFO:     connection open
INFO:app.routes.websocket:Found conversation: c7217cb0-a35d-4cc6-aa65-1a024155eb34
INFO:     127.0.0.1:63884 - "OPTIONS /api/documents/upload HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:utils.storage:File df8f8d30-5fd6-4378-a99b-0393df092f3c.pdf saved to ./uploads/df8f8d30-5fd6-4378-a99b-0393df092f3c.pdf
INFO:     127.0.0.1:63884 - "POST /api/documents/upload HTTP/1.1" 200 OK
INFO:pdf_processing.document_service:Starting optimized processing of document df8f8d30-5fd6-4378-a99b-0393df092f3c (Bank_5Q_Trend_Report.pdf) with Claude Files API
INFO:pdf_processing.document_service:No cached file_id for document df8f8d30-5fd6-4378-a99b-0393df092f3c, performing full processing
INFO:pdf_processing.api_service:Processing PDF: Bank_5Q_Trend_Report.pdf with Claude API using native PDF support.
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/files "HTTP/1.1 200 OK"
INFO:utils.file_cache:Cached file_id=file_011CQJrPzxFrNnRvM6Yv1rMr for content hash=9c15100a12f1a9ad... (expires: 2025-09-17 23:36:23, cache size: 1)
INFO:audit.pdf_access:PDF_ACCESS: {'timestamp': 'AUTO', 'operation': 'upload', 'file_id': 'file_011CQJrPzxFrNnRvM6Yv1rMr', 'user_context': 'system', 'file_size_bytes': 29802, 'privacy_note': 'PDF content not logged for compliance'}
INFO:pdf_processing.claude_file_client:Uploaded Bank_5Q_Trend_Report.pdf (0.0 MB) → file_011CQJrPzxFrNnRvM6Yv1rMr
INFO:pdf_processing.api_service:Generated Claude file_id file_011CQJrPzxFrNnRvM6Yv1rMr for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Analyzing document type for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Analyzing document type for Bank_5Q_Trend_Report.pdf using file_id=file_011CQJrPzxFrNnRvM6Yv1rMr
INFO:pdf_processing.model_router:Using Haiku for light tools set() with 1000 tokens (haiku_calls=1, sonnet_calls=0)
INFO:pdf_processing.api_service:Model router selected claude-3-5-haiku-20241022 for document type analysis
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 117 (Custom estimate: 117)
INFO:pdf_processing.api_service:Throttling based on token count: 117 (SDK count: 117, Custom estimate: 117)
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Document Bank_5Q_Trend_Report.pdf classified as integrated_financial_report with periods: ['2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1']
INFO:pdf_processing.api_service:Document Bank_5Q_Trend_Report.pdf classified as: integrated_financial_report with periods: ['2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1']
INFO:pdf_processing.api_service:Extracting structured financial data and citations for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Extracting structured financial data with citations from: Bank_5Q_Trend_Report.pdf using file_id file_011CQJrPzxFrNnRvM6Yv1rMr
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 181 (Custom estimate: 107)
INFO:pdf_processing.api_service:Throttling based on token count: 181 (SDK count: 181, Custom estimate: 107)
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Successfully parsed financial JSON from Claude's response.
INFO:pdf_processing.api_service:Captured Claude's preamble text, length: 240
INFO:pdf_processing.api_service:Extracted 0 citations for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Structured financial data keys for Bank_5Q_Trend_Report.pdf: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json']
INFO:pdf_processing.api_service:Added claude_file_id file_011CQJrPzxFrNnRvM6Yv1rMr to extracted_data for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.document_service:Processed document using Files API: PDF Bank_5Q_Trend_Report.pdf processed using Claude's native PDF support via Files API
INFO:pdf_processing.document_service:Extracted claude_file_id file_011CQJrPzxFrNnRvM6Yv1rMr from processed document data
INFO:pdf_processing.document_service:Stored claude_file_id file_011CQJrPzxFrNnRvM6Yv1rMr in database for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:pdf_processing.document_service:Updating document df8f8d30-5fd6-4378-a99b-0393df092f3c content with Claude optimizations using Files API
INFO:pdf_processing.document_service:Document df8f8d30-5fd6-4378-a99b-0393df092f3c processed with Claude optimizations. File ID: file_011CQJrPzxFrNnRvM6Yv1rMr
INFO:pdf_processing.document_service:Storing 0 citations for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:pdf_processing.document_service:Successfully completed optimized processing for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document df8f8d30-5fd6-4378-a99b-0393df092f3c accepted for financial analysis
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/check-financial-data HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document df8f8d30-5fd6-4378-a99b-0393df092f3c accepted for financial analysis
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/check-financial-data HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "OPTIONS /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/verify-financial-data HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document df8f8d30-5fd6-4378-a99b-0393df092f3c has extracted_data with keys: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:     127.0.0.1:63884 - "POST /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/verify-financial-data HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:     127.0.0.1:63884 - "OPTIONS /api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/document/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63884 - "POST /api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/document/df8f8d30-5fd6-4378-a99b-0393df092f3c HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Retrieving file for document: df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:app.routes.document:Returning binary PDF data for document df8f8d30-5fd6-4378-a99b-0393df092f3c, size: 29802 bytes
INFO:     127.0.0.1:63884 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/file HTTP/1.1" 200 OK
INFO:     127.0.0.1:63892 - "GET /api/documents/df8f8d30-5fd6-4378-a99b-0393df092f3c/citations HTTP/1.1" 200 OK
INFO:repositories.document_repository:Retrieving document content using file path: df8f8d30-5fd6-4378-a99b-0393df092f3c.pdf
INFO:repositories.document_repository:Requesting file from storage service for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:repositories.document_repository:Retrieved PDF content for document df8f8d30-5fd6-4378-a99b-0393df092f3c: 29802 bytes
INFO:repositories.document_repository:Document df8f8d30-5fd6-4378-a99b-0393df092f3c has claude_file_id: file_011CQJrPzxFrNnRvM6Yv1rMr (native PDF support available)
INFO:repositories.document_repository:PDF document df8f8d30-5fd6-4378-a99b-0393df092f3c uses claude_file_id for native support - raw_text not required
INFO:repositories.document_repository:Extracted data available for document df8f8d30-5fd6-4378-a99b-0393df092f3c: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:repositories.document_repository:Successfully retrieved content for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:services.conversation_service:Retrieved content for document df8f8d30-5fd6-4378-a99b-0393df092f3c: content size=29802, raw_text size=0
INFO:services.conversation_service:Document df8f8d30-5fd6-4378-a99b-0393df092f3c available content types: content, extracted_data
INFO:services.conversation_service:Added document df8f8d30-5fd6-4378-a99b-0393df092f3c to context for conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34
INFO:repositories.document_repository:Retrieving document content using file path: df8f8d30-5fd6-4378-a99b-0393df092f3c.pdf
INFO:repositories.document_repository:Requesting file from storage service for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:repositories.document_repository:Retrieved PDF content for document df8f8d30-5fd6-4378-a99b-0393df092f3c: 29802 bytes
INFO:repositories.document_repository:Document df8f8d30-5fd6-4378-a99b-0393df092f3c has claude_file_id: file_011CQJrPzxFrNnRvM6Yv1rMr (native PDF support available)
INFO:repositories.document_repository:PDF document df8f8d30-5fd6-4378-a99b-0393df092f3c uses claude_file_id for native support - raw_text not required
INFO:repositories.document_repository:Extracted data available for document df8f8d30-5fd6-4378-a99b-0393df092f3c: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:repositories.document_repository:Successfully retrieved content for document df8f8d30-5fd6-4378-a99b-0393df092f3c
INFO:services.conversation_service:Added document df8f8d30-5fd6-4378-a99b-0393df092f3c with Files API file_id: file_011CQJrPzxFrNnRvM6Yv1rMr
INFO:services.conversation_service:Using unified streaming approach with tools available for conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34
INFO:services.conversation_service:Using Files API claude_file_id file_011CQJrPzxFrNnRvM6Yv1rMr for unified streaming analysis
INFO:pdf_processing.api_service:Starting streaming analyze_with_visualization_tools for query: 'How has credit performed?...'
INFO:pdf_processing.api_service:Streaming visualization analysis turn 1/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_table_data', 'generate_financial_metric', 'generate_graph_data', 'generate_comparative_period'} with 46 tokens (haiku_calls=1, sonnet_calls=1)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 4321 (Custom estimate: 39)
INFO:pdf_processing.api_service:Throttling based on token count: 4321 (SDK count: 4321, Custom estimate: 39)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
ERROR:sqlalchemy.pool.impl.NullPool:The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <Connection(Thread-35, started daemon 6214512640)>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
/Users/alexcardell/AlexCoding_Local/venv/lib/python3.9/site-packages/pydantic/_internal/_core_utils.py:301: SAWarning: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <Connection(Thread-35, started daemon 6214512640)>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
  for v in schema['choices']:
INFO:repositories.conversation_repository:Updated and re-fetched message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:Building initial content (3 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:Building initial content (46 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:Building initial content (78 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:PRESERVED initial streaming content (104 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (145 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (189 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (217 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (250 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (277 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (299 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (321 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (355 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (369 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (381 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (390 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (399 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (406 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (440 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (458 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (500 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (536 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (563 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (597 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (625 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (641 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (662 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (702 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (722 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (743 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (771 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (791 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (811 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (831 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (850 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (860 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (879 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (902 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (930 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (947 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (954 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1011 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1027 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1076 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1094 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1104 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1151 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1170 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1194 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1212 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (1237 chars)
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_graph_data: type=<class 'dict'>
INFO:pdf_processing.api_service:Turn 1: Initial streaming text preserved (1237 chars)
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_graph_data (ID: toolu_01CZfNZBAFyL1GoaPFRAt7EF)
INFO:pdf_processing.api_service:Processing streaming tool generate_graph_data (ID: toolu_01CZfNZBAFyL1GoaPFRAt7EF)
INFO:pdf_processing.api_service:Tool generate_graph_data (ID: toolu_01CZfNZBAFyL1GoaPFRAt7EF) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_graph_data (ID: toolu_01CZfNZBAFyL1GoaPFRAt7EF) - dict input keys: ['chartType', 'config', 'data', 'chartConfig']
INFO:utils.tool_processing:Processing generate_graph_data (ID: toolu_01CZfNZBAFyL1GoaPFRAt7EF) - input type: <class 'dict'>
INFO:utils.tool_processing:Starting process_chart_input with input type: <class 'dict'>
INFO:utils.tool_processing:Chart input keys: ['chartType', 'config', 'data', 'chartConfig']
INFO:utils.tool_processing:Chart config type: <class 'str'>
INFO:utils.tool_processing:Chart data type: <class 'list'>, length: 5
INFO:utils.tool_processing:Chart chartConfig type: <class 'dict'>
WARNING:utils.tool_processing:Chart config is a JSON string, parsing it
INFO:utils.tool_processing:Successfully parsed config JSON string
INFO:utils.tool_processing:Chart config keys: ['title', 'xAxisKey', 'xAxisLabel', 'yAxisLabel', 'description']
INFO:utils.tool_processing:Successfully got original_data: type=<class 'list'>
INFO:utils.tool_processing:Chart type: line
INFO:utils.tool_processing:Chart config settings type: <class 'dict'>
INFO:utils.tool_processing:x_axis_key: period
INFO:utils.tool_processing:Transforming chart data to {x, y} format required by ChartDataItem model
INFO:utils.tool_processing:Line chart with multiple series (['npa', 'nonaccrual', 'pastdue']) - keeping flat format
INFO:utils.tool_processing:Successfully processed chart: Credit Quality Trends
INFO:pdf_processing.api_service:Streaming visualization analysis turn 2/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_table_data', 'generate_financial_metric', 'generate_graph_data', 'generate_comparative_period'} with 916 tokens (haiku_calls=1, sonnet_calls=2)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 5456 (Custom estimate: 349)
INFO:pdf_processing.api_service:Throttling based on token count: 5456 (SDK count: 5456, Custom estimate: 349)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_table_data: type=<class 'dict'>
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_table_data (ID: toolu_01UeyNnhYxjJR2gPVpHQsWHd)
INFO:pdf_processing.api_service:Processing streaming tool generate_table_data (ID: toolu_01UeyNnhYxjJR2gPVpHQsWHd)
INFO:pdf_processing.api_service:Tool generate_table_data (ID: toolu_01UeyNnhYxjJR2gPVpHQsWHd) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_table_data (ID: toolu_01UeyNnhYxjJR2gPVpHQsWHd) - dict input keys: ['tableType', 'config', 'data']
INFO:utils.tool_processing:Processing generate_table_data (ID: toolu_01UeyNnhYxjJR2gPVpHQsWHd) - input type: <class 'dict'>
INFO:utils.tool_processing:Starting process_table_input with input type: <class 'dict'>
INFO:utils.tool_processing:Table input keys: ['tableType', 'config', 'data']
INFO:utils.tool_processing:Table config type: <class 'str'>
INFO:utils.tool_processing:Table data type: <class 'list'>, length: 4
WARNING:utils.tool_processing:Table config is a JSON string, parsing it
INFO:utils.tool_processing:Successfully parsed table config JSON string
INFO:utils.tool_processing:Successfully processed table: Credit Performance Metrics
INFO:pdf_processing.api_service:Streaming visualization analysis turn 3/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_table_data', 'generate_financial_metric', 'generate_graph_data', 'generate_comparative_period'} with 1523 tokens (haiku_calls=1, sonnet_calls=3)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 6404 (Custom estimate: 349)
INFO:pdf_processing.api_service:Throttling based on token count: 6404 (SDK count: 6404, Custom estimate: 349)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_financial_metric: type=<class 'dict'>
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_financial_metric (ID: toolu_013Soeh4QhD5TG7hAriH4yE4)
INFO:pdf_processing.api_service:Processing streaming tool generate_financial_metric (ID: toolu_013Soeh4QhD5TG7hAriH4yE4)
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_013Soeh4QhD5TG7hAriH4yE4) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_013Soeh4QhD5TG7hAriH4yE4) - dict input keys: ['category', 'name', 'period', 'value', 'unit', 'isEstimated']
INFO:utils.tool_processing:Processing generate_financial_metric (ID: toolu_013Soeh4QhD5TG7hAriH4yE4) - input type: <class 'dict'>
INFO:utils.tool_processing:Successfully processed financial metric: NPAs to Total Loans
INFO:pdf_processing.api_service:Streaming visualization analysis turn 4/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_table_data', 'generate_financial_metric', 'generate_graph_data', 'generate_comparative_period'} with 1639 tokens (haiku_calls=1, sonnet_calls=4)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 6617 (Custom estimate: 349)
INFO:pdf_processing.api_service:Throttling based on token count: 6617 (SDK count: 6617, Custom estimate: 349)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_financial_metric: type=<class 'dict'>
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_financial_metric (ID: toolu_01RwoJewgQfbaTCoi3YmuRnA)
INFO:pdf_processing.api_service:Processing streaming tool generate_financial_metric (ID: toolu_01RwoJewgQfbaTCoi3YmuRnA)
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01RwoJewgQfbaTCoi3YmuRnA) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01RwoJewgQfbaTCoi3YmuRnA) - dict input keys: ['category', 'name', 'period', 'value', 'unit', 'isEstimated']
INFO:utils.tool_processing:Processing generate_financial_metric (ID: toolu_01RwoJewgQfbaTCoi3YmuRnA) - input type: <class 'dict'>
INFO:utils.tool_processing:Successfully processed financial metric: Reserve Coverage Ratio
INFO:pdf_processing.api_service:Streaming visualization analysis turn 5/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_table_data', 'generate_financial_metric', 'generate_graph_data', 'generate_comparative_period'} with 1756 tokens (haiku_calls=1, sonnet_calls=5)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 6824 (Custom estimate: 349)
INFO:pdf_processing.api_service:Throttling based on token count: 6824 (SDK count: 6824, Custom estimate: 349)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (3 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (32 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (56 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (66 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (89 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (109 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (123 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (140 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (146 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (153 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (168 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (196 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (226 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (260 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (295 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (298 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (324 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (342 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (347 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (371 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (379 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (396 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (415 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (433 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (450 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (458 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (479 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (489 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (502 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (535 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (555 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (567 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (584 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (614 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (647 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (704 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (755 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (795 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (840 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (897 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (927 chars)
INFO:pdf_processing.api_service:Turn 5: Adding new content (927 chars)
INFO:pdf_processing.api_service:Streaming visualization analysis completed: no more tools
INFO:pdf_processing.api_service:Streaming visualization analysis completed: 1 charts, 1 tables, 2 metrics. Analysis text length: 2166
INFO:services.conversation_service:Current assistant message content length: 104
INFO:services.conversation_service:Analysis text length: 2166
INFO:services.conversation_service:Initial content established: True
INFO:services.conversation_service:PROTECTING preserved initial content (104 chars) - ignoring post-tool analysis
INFO:repositories.conversation_repository:Updated and re-fetched message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:Preserved initial streaming content without post-tool modifications
INFO:services.conversation_service:DATABASE WRITE VERIFIED: Final message content length: 104 chars
INFO:services.conversation_service:DATABASE CONTENT PREVIEW: Let me provide a comprehensive analysis of the credit performance based on the financial documents.
...
INFO:services.conversation_service:Sent message_update event for ea159694-892b-4a6a-b8eb-d8ac9cd19f21 after streaming complete
INFO:services.conversation_service:DEBUG: result.get('metrics'): [{'category': 'Credit Quality', 'name': 'NPAs to Total Loans', 'period': '2025Q1', 'value': 0.867, 'unit': '%', 'isEstimated': False}, {'category': 'Credit Quality', 'name': 'Reserve Coverage Ratio', 'period': '2025Q1', 'value': 100.0, 'unit': '%', 'isEstimated': False}]
INFO:services.conversation_service:DEBUG: accumulated_metrics: [{'category': 'Credit Quality', 'name': 'NPAs to Total Loans', 'period': '2025Q1', 'value': 0.867, 'unit': '%', 'isEstimated': False}, {'category': 'Credit Quality', 'name': 'Reserve Coverage Ratio', 'period': '2025Q1', 'value': 100.0, 'unit': '%', 'isEstimated': False}]
INFO:services.conversation_service:Processing visualizations for conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34: charts=1, tables=1, metrics=2
INFO:services.conversation_service:Processing chart: Credit Quality Trends
INFO:services.conversation_service:Processing table: Credit Performance Metrics
INFO:services.conversation_service:Processing metric: NPAs to Total Loans
INFO:services.conversation_service:Processing metric: Reserve Coverage Ratio
INFO:services.conversation_service:Storing 4 analysis blocks for streaming message ea159694-892b-4a6a-b8eb-d8ac9cd19f21
INFO:services.conversation_service:Refreshed streaming assistant_message ea159694-892b-4a6a-b8eb-d8ac9cd19f21 to load analysis_blocks
INFO:services.conversation_service:Sending message_complete event for conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34 after analysis blocks stored
INFO:services.conversation_service:message_complete event sent for conversation c7217cb0-a35d-4cc6-aa65-1a024155eb34 after analysis blocks
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63898 - "GET /api/conversation/message/ea159694-892b-4a6a-b8eb-d8ac9cd19f21 HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:pdf_processing.api_service:Sending request to Claude API with 1 messages, streaming: False
INFO:pdf_processing.api_service:Sending request to Claude API with 1 messages, streaming: False
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (generate_response non-streaming): 254
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 254 (Custom estimate: 259)
INFO:pdf_processing.api_service:Throttling based on token count: 254 (SDK count: 254, Custom estimate: 259)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (generate_response non-streaming): 254
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 254 (Custom estimate: 259)
INFO:pdf_processing.api_service:Throttling based on token count: 254 (SDK count: 254, Custom estimate: 259)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:     127.0.0.1:63899 - "POST /api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/generate-followups?limit=3 HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:     127.0.0.1:63898 - "POST /api/conversation/c7217cb0-a35d-4cc6-aa65-1a024155eb34/generate-followups?limit=3 HTTP/1.1" 200 OK
</Backend_Logs>