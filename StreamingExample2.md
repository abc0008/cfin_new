<Initial_Streaming_Response>

Let me provide a comprehensive analysis of the deposit mix trends over the reported periods.

The deposit mix shows interesting evolutionary patterns from 2024Q1 through 2025Q1. Total deposits have shown steady growth, increasing from $46,000M to $47,700M, representing a 3.7% increase over the five quarters. Let me break down the key trends in deposit composition and provide detailed visualizations.

The data shows that Money Market (MMDA) accounts consistently represent the largest portion of deposits, followed by non-interest DDA accounts. Time deposits and savings accounts maintain identical balances throughout the periods, suggesting a strategic alignment in these product offerings.

Let me generate some visualizations to better illustrate these trends:

</Initial_Streaming_Response>

<Post_Visualization_Streaming_Response>
Let me provide a comprehensive analysis of the deposit mix trends over the reported periods.
The deposit mix shows
Let me provide a comprehensive analysis of the deposit mix trends over the reported periods. The deposit mix shows


</Post_Visualization_Streaming_Response>

<JavaScript_Console_Output>
[Log] Upload progress: 100.00%, Stage: Document ready
[Log] Document verification completed: – {metadata: Object, contentType: "balance_sheet", extractionTimestamp: "2025-06-20T04:22:55.296Z", …}
{metadata: Object, contentType: "balance_sheet", extractionTimestamp: "2025-06-20T04:22:55.296Z", periods: ["2024Q1", "2024Q2", "2024Q3", "2024Q4", "2025Q1"], extractedData: Object, …}Object
[Log] Associating document 6f364dbb-f28d-40b1-9322-cff65f5346ed with conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3
[Log] Sending POST request to http://localhost:8000/api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/document/6f364dbb-f28d-40b1-9322-cff65f5346ed
[Log] Document 6f364dbb-f28d-40b1-9322-cff65f5346ed added to conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3
[Log] Document successfully associated with conversation
[Error] Failed to load resource: the server responded with a status of 404 (Not Found) (types.js.map, line 0)
[Log] PDFViewer unmounting, cleaning up resources
[Log] Sending GET request to http://localhost:8000/api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/citations
[Log] Deprecated API usage: The `enhanceTextSelection` functionality will be removed in the future. (x3)
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] PDFViewer unmounting, cleaning up resources
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 1 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Submit conditions: useStreaming=true, conversationId=51be33e8-f07d-4c4a-a089-3a90c74959e3, isConnected=true
[Log] Using WebSocket streaming for message submission
[Log] Checking 2 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Checking 2 messages for cumulative visualization data...
[Log] No structured visualization data found in messages or analysis results, returning empty structure
[Log] Updating with preserved initial content (115 chars)
[Log] Backend protecting content - maintaining frontend streaming text (0 chars) (x72)
[Log] Message complete for null, fetching complete message from database
[Log] HTTP fallback: Message complete for 45873c30-ca55-4e05-b180-a3c84e49da07, fetching from database
[Log] Sending GET request to http://localhost:8000/api/conversation/message/45873c30-ca55-4e05-b180-a3c84e49da07
[Log] Received HTTP message with 0 analysis blocks
[Log] Streaming message update: – {id: "45873c30-ca55-4e05-b180-a3c84e49da07", sessionId: "51be33e8-f07d-4c4a-a089-3a90c74959e3", timestamp: "2025-06-20T04:23:49.694752Z", …}
{id: "45873c30-ca55-4e05-b180-a3c84e49da07", sessionId: "51be33e8-f07d-4c4a-a089-3a90c74959e3", timestamp: "2025-06-20T04:23:49.694752Z", role: "assistant", content: "Let me provide a comprehensive analysis of the dep…over the reported periods.↵↵The deposit mix shows", …}Object
[Log] Checking 3 messages for cumulative visualization data...
[Log] Examining assistant message 2: – "ID: 45873c30-ca55-4e05-b180-a3c84e49da07" – "Has 4 analysis blocks"
[Log] Found 4 analysis blocks in message 45873c30-ca55-4e05-b180-a3c84e49da07
[Log] Analysis blocks structure: – "{↵  \"id\": \"2af65e24-70c5-4768-9872-15ad78307939\",↵  \"block_type\": \"chart\",↵  \"title\": \"Deposit Mix Composition Over Time\",↵  \"content\": {↵…"
"{
  \"id\": \"2af65e24-70c5-4768-9872-15ad78307939\",
  \"block_type\": \"chart\",
  \"title\": \"Deposit Mix Composition Over Time\",
  \"content\": {
    \"chartType\": \"stackedArea\",
    \"config\": {
      \"title\":..."
[Log] Processing analysis block 0: type=chart, title=Deposit Mix Composition Over Time
[Log] Found direct chart data in block 0: stackedArea
[Log] Chart data structure: – {hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", …], …}
{hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], dataLength: 5, sampleData: Object}Object
[Log] Processing analysis block 1: type=table, title=Deposit Mix Analysis
[Log] Found direct table data in block 1: detailed
[Log] Processing analysis block 2: type=metric, title=MMDA to Total Deposits Ratio
[Log] Found metric block 2: MMDA to Total Deposits Ratio
[Log] Processing analysis block 3: type=metric, title=Non-interest DDA to Total Deposits Ratio
[Log] Found metric block 3: Non-interest DDA to Total Deposits Ratio
[Log] Returning cumulative visualization data from analysis_blocks: 1 charts, 1 tables, 2 metrics
[Log] Checking 3 messages for cumulative visualization data...
[Log] Examining assistant message 2: – "ID: 45873c30-ca55-4e05-b180-a3c84e49da07" – "Has 4 analysis blocks"
[Log] Found 4 analysis blocks in message 45873c30-ca55-4e05-b180-a3c84e49da07
[Log] Analysis blocks structure: – "{↵  \"id\": \"2af65e24-70c5-4768-9872-15ad78307939\",↵  \"block_type\": \"chart\",↵  \"title\": \"Deposit Mix Composition Over Time\",↵  \"content\": {↵…"
"{
  \"id\": \"2af65e24-70c5-4768-9872-15ad78307939\",
  \"block_type\": \"chart\",
  \"title\": \"Deposit Mix Composition Over Time\",
  \"content\": {
    \"chartType\": \"stackedArea\",
    \"config\": {
      \"title\":..."
[Log] Processing analysis block 0: type=chart, title=Deposit Mix Composition Over Time
[Log] Found direct chart data in block 0: stackedArea
[Log] Chart data structure: – {hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", …], …}
{hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], dataLength: 5, sampleData: Object}Object
[Log] Processing analysis block 1: type=table, title=Deposit Mix Analysis
[Log] Found direct table data in block 1: detailed
[Log] Processing analysis block 2: type=metric, title=MMDA to Total Deposits Ratio
[Log] Found metric block 2: MMDA to Total Deposits Ratio
[Log] Processing analysis block 3: type=metric, title=Non-interest DDA to Total Deposits Ratio
[Log] Found metric block 3: Non-interest DDA to Total Deposits Ratio
[Log] Returning cumulative visualization data from analysis_blocks: 1 charts, 1 tables, 2 metrics
[Log] ChartRenderer - Data received: – {chartType: "stackedArea", hasData: true, dataLength: 5, …}
{chartType: "stackedArea", hasData: true, dataLength: 5, hasConfig: true, hasChartConfig: true, …}Object
[Log] ChartRenderer - Data received: – {chartType: "stackedArea", hasData: true, dataLength: 5, …}
{chartType: "stackedArea", hasData: true, dataLength: 5, hasConfig: true, hasChartConfig: true, …}Object
[Log] AreaChart - Debug Info: – {chartType: "stackedArea", hasConfig: true, hasChartConfig: true, …}
{chartType: "stackedArea", hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], dataLength: 5, …}Object
[Log] AreaChart - Transforming multi-series data to flat format for Recharts
[Log] AreaChart - Multi-series transformation complete: – {originalSeriesCount: 5, transformedDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …], …}
{originalSeriesCount: 5, transformedDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"], firstTransformedItem: Object}Object
[Log] AreaChart - Final processed data structure: – {chartDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …], firstChartItem: Object, …}
{chartDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"], firstChartItem: Object, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], …}Object
[Log] AreaChart - Numeric values extracted: – {allValues: Array, allValuesLength: 25, dataKeysUsed: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …]}
{allValues: Array, allValuesLength: 25, dataKeysUsed: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"]}Object
[Log] AreaChart - Rendering area 0: key=Non-interest DDA, safeKey=NoninterestDDA, color=#8f0f56
[Log] AreaChart - Rendering area 1: key=NOW Accounts, safeKey=NOWAccounts, color=#02a88e
[Log] AreaChart - Rendering area 2: key=Money Market (MMDA), safeKey=MoneyMarketMMDA, color=#00bed5
[Log] AreaChart - Rendering area 3: key=Savings, safeKey=Savings, color=#e5241d
[Log] AreaChart - Rendering area 4: key=Time Deposits/CDs, safeKey=TimeDepositsCDs, color=#2c3e50
[Log] AreaChart - Debug Info: – {chartType: "stackedArea", hasConfig: true, hasChartConfig: true, …}
{chartType: "stackedArea", hasConfig: true, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], dataLength: 5, …}Object
[Log] AreaChart - Transforming multi-series data to flat format for Recharts
[Log] AreaChart - Multi-series transformation complete: – {originalSeriesCount: 5, transformedDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …], …}
{originalSeriesCount: 5, transformedDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"], firstTransformedItem: Object}Object
[Log] AreaChart - Final processed data structure: – {chartDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …], firstChartItem: Object, …}
{chartDataLength: 5, dataKeys: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"], firstChartItem: Object, hasChartConfig: true, chartConfigKeys: ["nonInterestDDA", "nowAccounts", "mmda", "savings", "timeDeposits"], …}Object
[Log] AreaChart - Numeric values extracted: – {allValues: Array, allValuesLength: 25, dataKeysUsed: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", …]}
{allValues: Array, allValuesLength: 25, dataKeysUsed: ["Non-interest DDA", "NOW Accounts", "Money Market (MMDA)", "Savings", "Time Deposits/CDs"]}Object
[Log] AreaChart - Rendering area 0: key=Non-interest DDA, safeKey=NoninterestDDA, color=#8f0f56
[Log] AreaChart - Rendering area 1: key=NOW Accounts, safeKey=NOWAccounts, color=#02a88e
[Log] AreaChart - Rendering area 2: key=Money Market (MMDA), safeKey=MoneyMarketMMDA, color=#00bed5
[Log] AreaChart - Rendering area 3: key=Savings, safeKey=Savings, color=#e5241d
[Log] AreaChart - Rendering area 4: key=Time Deposits/CDs, safeKey=TimeDepositsCDs, color=#2c3e50
[Log] Sending POST request to http://localhost:8000/api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/generate-followups?limit=3
[Log] Sending POST request to http://localhost:8000/api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/generate-followups?limit=3
[Log] Generated 3 follow-up questions for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3 (x2)
</JavaScript_Console_Output>

<Backend_Logs> 
(venv) alexcardell@Alexs-MBP backend % cd /Users/alexcardell/AlexCoding_Local/cfin/backend && PYTHONPATH=$PYTHONPATH:/Users/alexcardell/AlexCoding_Local/cfin/backend python -m uvicorn app.main:app --reload --port 8000
INFO:     Will watch for changes in these directories: ['/Users/alexcardell/AlexCoding_Local/cfin/backend']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [76927] using StatReload
INFO:root:Loaded environment variables from /Users/alexcardell/AlexCoding_Local/cfin/.env
INFO:root:ANTHROPIC_API_KEY loaded: sk-ant-a...TQAA
INFO:app.main:CORS: Allowing origins: ['http://localhost:3000', 'http://localhost:3001', 'http://localhost:3002', 'http://localhost:3003', 'http://127.0.0.1:3000', 'http://127.0.0.1:3001', 'http://127.0.0.1:3002', 'http://127.0.0.1:3003', 'http://127.0.0.1:49937', 'http://127\\.0\\.0\\.1:\\d+', 'http://127.0.0.1:64142']
INFO:     Started server process [76929]
INFO:     Waiting for application startup.
INFO:app.main:Initializing database...
INFO:utils.init_db:Creating database tables...
INFO:utils.init_db:Database tables created successfully.
INFO:utils.init_db:Default user already exists.
INFO:utils.init_db:Database initialization completed successfully.
INFO:app.main:Database initialization completed successfully
INFO:     Application startup complete.
INFO:     127.0.0.1:63305 - "OPTIONS /api/conversation HTTP/1.1" 200 OK
INFO:     127.0.0.1:63306 - "OPTIONS /api/conversation HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.conversation:Created conversation: 612a6c6c-56c6-4952-bbe4-a4f183f12f58 for user: default-user
INFO:app.routes.conversation:Created conversation: 51be33e8-f07d-4c4a-a089-3a90c74959e3 for user: default-user
INFO:     127.0.0.1:63305 - "POST /api/conversation HTTP/1.1" 201 Created
INFO:     127.0.0.1:63306 - "POST /api/conversation HTTP/1.1" 201 Created
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63305 - "GET /api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3 HTTP/1.1" 200 OK
INFO:app.routes.websocket:WebSocket endpoint called for conversation: 51be33e8-f07d-4c4a-a089-3a90c74959e3, user: default-user
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     ('127.0.0.1', 63306) - "WebSocket /ws/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3" [accepted]
INFO:app.routes.websocket:WebSocket connected: default-user_51be33e8-f07d-4c4a-a089-3a90c74959e3_1750393364710
INFO:app.routes.websocket:WebSocket connection established for conversation: 51be33e8-f07d-4c4a-a089-3a90c74959e3
INFO:     connection open
INFO:app.routes.websocket:Found conversation: 51be33e8-f07d-4c4a-a089-3a90c74959e3
INFO:     127.0.0.1:63307 - "OPTIONS /api/documents/upload HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:utils.storage:File 6f364dbb-f28d-40b1-9322-cff65f5346ed.pdf saved to ./uploads/6f364dbb-f28d-40b1-9322-cff65f5346ed.pdf
INFO:     127.0.0.1:63307 - "POST /api/documents/upload HTTP/1.1" 200 OK
INFO:pdf_processing.document_service:Starting optimized processing of document 6f364dbb-f28d-40b1-9322-cff65f5346ed (Bank_5Q_Trend_Report.pdf) with Claude Files API
INFO:pdf_processing.document_service:No cached file_id for document 6f364dbb-f28d-40b1-9322-cff65f5346ed, performing full processing
INFO:pdf_processing.api_service:Processing PDF: Bank_5Q_Trend_Report.pdf with Claude API using native PDF support.
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/files "HTTP/1.1 200 OK"
INFO:utils.file_cache:Cached file_id=file_011CQJqNVAiZvaHuwULbmEgt for content hash=9c15100a12f1a9ad... (expires: 2025-09-17 23:22:55, cache size: 1)
INFO:audit.pdf_access:PDF_ACCESS: {'timestamp': 'AUTO', 'operation': 'upload', 'file_id': 'file_011CQJqNVAiZvaHuwULbmEgt', 'user_context': 'system', 'file_size_bytes': 29802, 'privacy_note': 'PDF content not logged for compliance'}
INFO:pdf_processing.claude_file_client:Uploaded Bank_5Q_Trend_Report.pdf (0.0 MB) → file_011CQJqNVAiZvaHuwULbmEgt
INFO:pdf_processing.api_service:Generated Claude file_id file_011CQJqNVAiZvaHuwULbmEgt for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Analyzing document type for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Analyzing document type for Bank_5Q_Trend_Report.pdf using file_id=file_011CQJqNVAiZvaHuwULbmEgt
INFO:pdf_processing.model_router:Using Haiku for light tools set() with 1000 tokens (haiku_calls=1, sonnet_calls=0)
INFO:pdf_processing.api_service:Model router selected claude-3-5-haiku-20241022 for document type analysis
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 117 (Custom estimate: 117)
INFO:pdf_processing.api_service:Throttling based on token count: 117 (SDK count: 117, Custom estimate: 117)
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Document Bank_5Q_Trend_Report.pdf classified as balance_sheet with periods: ['2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1']
INFO:pdf_processing.api_service:Document Bank_5Q_Trend_Report.pdf classified as: balance_sheet with periods: ['2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1']
INFO:pdf_processing.api_service:Extracting structured financial data and citations for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Extracting structured financial data with citations from: Bank_5Q_Trend_Report.pdf using file_id file_011CQJqNVAiZvaHuwULbmEgt
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 179 (Custom estimate: 103)
INFO:pdf_processing.api_service:Throttling based on token count: 179 (SDK count: 179, Custom estimate: 103)
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Successfully parsed financial JSON from Claude's response.
INFO:pdf_processing.api_service:Captured Claude's preamble text, length: 243
INFO:pdf_processing.api_service:Extracted 0 citations for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.api_service:Structured financial data keys for Bank_5Q_Trend_Report.pdf: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json']
INFO:pdf_processing.api_service:Added claude_file_id file_011CQJqNVAiZvaHuwULbmEgt to extracted_data for Bank_5Q_Trend_Report.pdf
INFO:pdf_processing.document_service:Processed document using Files API: PDF Bank_5Q_Trend_Report.pdf processed using Claude's native PDF support via Files API
INFO:pdf_processing.document_service:Extracted claude_file_id file_011CQJqNVAiZvaHuwULbmEgt from processed document data
INFO:pdf_processing.document_service:Stored claude_file_id file_011CQJqNVAiZvaHuwULbmEgt in database for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:pdf_processing.document_service:Updating document 6f364dbb-f28d-40b1-9322-cff65f5346ed content with Claude optimizations using Files API
INFO:pdf_processing.document_service:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed processed with Claude optimizations. File ID: file_011CQJqNVAiZvaHuwULbmEgt
INFO:pdf_processing.document_service:Storing 0 citations for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:pdf_processing.document_service:Successfully completed optimized processing for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed accepted for financial analysis
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/check-financial-data HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed accepted for financial analysis
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/check-financial-data HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "OPTIONS /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/verify-financial-data HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed has extracted_data with keys: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:     127.0.0.1:63307 - "POST /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/verify-financial-data HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:     127.0.0.1:63307 - "OPTIONS /api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/document/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63307 - "POST /api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/document/6f364dbb-f28d-40b1-9322-cff65f5346ed HTTP/1.1" 200 OK
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:app.routes.document:Retrieving file for document: 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:app.routes.document:Returning binary PDF data for document 6f364dbb-f28d-40b1-9322-cff65f5346ed, size: 29802 bytes
INFO:     127.0.0.1:63307 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/file HTTP/1.1" 200 OK
INFO:     127.0.0.1:63314 - "GET /api/documents/6f364dbb-f28d-40b1-9322-cff65f5346ed/citations HTTP/1.1" 200 OK
INFO:repositories.document_repository:Retrieving document content using file path: 6f364dbb-f28d-40b1-9322-cff65f5346ed.pdf
INFO:repositories.document_repository:Requesting file from storage service for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:repositories.document_repository:Retrieved PDF content for document 6f364dbb-f28d-40b1-9322-cff65f5346ed: 29802 bytes
INFO:repositories.document_repository:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed has claude_file_id: file_011CQJqNVAiZvaHuwULbmEgt (native PDF support available)
INFO:repositories.document_repository:PDF document 6f364dbb-f28d-40b1-9322-cff65f5346ed uses claude_file_id for native support - raw_text not required
INFO:repositories.document_repository:Extracted data available for document 6f364dbb-f28d-40b1-9322-cff65f5346ed: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:repositories.document_repository:Successfully retrieved content for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:services.conversation_service:Retrieved content for document 6f364dbb-f28d-40b1-9322-cff65f5346ed: content size=29802, raw_text size=0
INFO:services.conversation_service:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed available content types: content, extracted_data
INFO:services.conversation_service:Added document 6f364dbb-f28d-40b1-9322-cff65f5346ed to context for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3
INFO:repositories.document_repository:Retrieving document content using file path: 6f364dbb-f28d-40b1-9322-cff65f5346ed.pdf
INFO:repositories.document_repository:Requesting file from storage service for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:repositories.document_repository:Retrieved PDF content for document 6f364dbb-f28d-40b1-9322-cff65f5346ed: 29802 bytes
INFO:repositories.document_repository:Document 6f364dbb-f28d-40b1-9322-cff65f5346ed has claude_file_id: file_011CQJqNVAiZvaHuwULbmEgt (native PDF support available)
INFO:repositories.document_repository:PDF document 6f364dbb-f28d-40b1-9322-cff65f5346ed uses claude_file_id for native support - raw_text not required
INFO:repositories.document_repository:Extracted data available for document 6f364dbb-f28d-40b1-9322-cff65f5346ed: ['time_periods', 'balance_sheet', 'income_statement', 'credit_quality', 'claude_textual_output_accompanying_json', 'claude_file_id']
INFO:repositories.document_repository:Successfully retrieved content for document 6f364dbb-f28d-40b1-9322-cff65f5346ed
INFO:services.conversation_service:Added document 6f364dbb-f28d-40b1-9322-cff65f5346ed with Files API file_id: file_011CQJqNVAiZvaHuwULbmEgt
INFO:services.conversation_service:Using unified streaming approach with tools available for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3
INFO:services.conversation_service:Using Files API claude_file_id file_011CQJqNVAiZvaHuwULbmEgt for unified streaming analysis
INFO:pdf_processing.api_service:Starting streaming analyze_with_visualization_tools for query: 'How have deposit mix changed through time?...'
INFO:pdf_processing.api_service:Streaming visualization analysis turn 1/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_comparative_period', 'generate_financial_metric', 'generate_table_data', 'generate_graph_data'} with 50 tokens (haiku_calls=1, sonnet_calls=1)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 4324 (Custom estimate: 44)
INFO:pdf_processing.api_service:Throttling based on token count: 4324 (SDK count: 4324, Custom estimate: 44)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
ERROR:sqlalchemy.pool.impl.NullPool:The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <Connection(Thread-34, started daemon 6209286144)>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
/Users/alexcardell/AlexCoding_Local/venv/lib/python3.9/site-packages/pydantic/_internal/_core_utils.py:301: SAWarning: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <Connection(Thread-34, started daemon 6209286144)>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
  for v in schema['choices']:
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (3 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (14 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (30 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (46 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (65 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (74 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (91 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Building initial content (97 chars)
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:PRESERVED initial streaming content (115 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (140 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (159 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (169 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (174 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (183 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (210 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (229 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (236 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (243 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (250 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (272 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (290 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (299 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (309 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (342 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (365 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (385 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (402 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (423 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (438 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (452 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (507 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (535 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (564 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (601 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (621 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (645 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (657 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (676 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (700 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (724 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (767 chars)
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_graph_data: type=<class 'dict'>
INFO:pdf_processing.api_service:Turn 1: Initial streaming text preserved (767 chars)
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_graph_data (ID: toolu_0155utHM128PApTyTgSVJoGH)
INFO:pdf_processing.api_service:Processing streaming tool generate_graph_data (ID: toolu_0155utHM128PApTyTgSVJoGH)
INFO:pdf_processing.api_service:Tool generate_graph_data (ID: toolu_0155utHM128PApTyTgSVJoGH) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_graph_data (ID: toolu_0155utHM128PApTyTgSVJoGH) - dict input keys: ['chartType', 'config', 'data', 'chartConfig']
INFO:utils.tool_processing:Processing generate_graph_data (ID: toolu_0155utHM128PApTyTgSVJoGH) - input type: <class 'dict'>
INFO:utils.tool_processing:Starting process_chart_input with input type: <class 'dict'>
INFO:utils.tool_processing:Chart input keys: ['chartType', 'config', 'data', 'chartConfig']
INFO:utils.tool_processing:Chart config type: <class 'str'>
INFO:utils.tool_processing:Chart data type: <class 'list'>, length: 5
INFO:utils.tool_processing:Chart chartConfig type: <class 'dict'>
WARNING:utils.tool_processing:Chart config is a JSON string, parsing it
INFO:utils.tool_processing:Successfully parsed config JSON string
INFO:utils.tool_processing:Chart config keys: ['title', 'xAxisKey', 'yAxisLabel', 'description', 'showLegend']
INFO:utils.tool_processing:Successfully got original_data: type=<class 'list'>
INFO:utils.tool_processing:Chart type: stackedArea
INFO:utils.tool_processing:Chart config settings type: <class 'dict'>
INFO:utils.tool_processing:x_axis_key: period
INFO:utils.tool_processing:Transforming chart data to {x, y} format required by ChartDataItem model
INFO:utils.tool_processing:Transformed 5 series for multi-series stackedArea chart
INFO:utils.tool_processing:Successfully processed chart: Deposit Mix Composition Over Time
INFO:pdf_processing.api_service:Streaming visualization analysis turn 2/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_comparative_period', 'generate_financial_metric', 'generate_table_data', 'generate_graph_data'} with 1081 tokens (haiku_calls=1, sonnet_calls=2)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 5811 (Custom estimate: 235)
INFO:pdf_processing.api_service:Throttling based on token count: 5811 (SDK count: 5811, Custom estimate: 235)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_table_data: type=<class 'dict'>
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_table_data (ID: toolu_01D9kQoSzVdWEiPBEW6fN1GJ)
INFO:pdf_processing.api_service:Processing streaming tool generate_table_data (ID: toolu_01D9kQoSzVdWEiPBEW6fN1GJ)
INFO:pdf_processing.api_service:Tool generate_table_data (ID: toolu_01D9kQoSzVdWEiPBEW6fN1GJ) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_table_data (ID: toolu_01D9kQoSzVdWEiPBEW6fN1GJ) - dict input keys: ['tableType', 'config', 'data']
INFO:utils.tool_processing:Processing generate_table_data (ID: toolu_01D9kQoSzVdWEiPBEW6fN1GJ) - input type: <class 'dict'>
INFO:utils.tool_processing:Starting process_table_input with input type: <class 'dict'>
INFO:utils.tool_processing:Table input keys: ['tableType', 'config', 'data']
INFO:utils.tool_processing:Table config type: <class 'str'>
INFO:utils.tool_processing:Table data type: <class 'list'>, length: 6
WARNING:utils.tool_processing:Table config is a JSON string, parsing it
INFO:utils.tool_processing:Successfully parsed table config JSON string
INFO:utils.tool_processing:Successfully processed table: Deposit Mix Analysis
INFO:pdf_processing.api_service:Streaming visualization analysis turn 3/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_comparative_period', 'generate_financial_metric', 'generate_table_data', 'generate_graph_data'} with 1810 tokens (haiku_calls=1, sonnet_calls=3)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 6972 (Custom estimate: 235)
INFO:pdf_processing.api_service:Throttling based on token count: 6972 (SDK count: 6972, Custom estimate: 235)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (3 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (21 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (33 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (63 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (64 chars)
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_financial_metric: type=<class 'dict'>
INFO:pdf_processing.api_service:Turn 3: Adding new content (64 chars)
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_financial_metric (ID: toolu_01D7AfWz12QrAu4LG9do88cZ)
INFO:pdf_processing.api_service:Processing streaming tool generate_financial_metric (ID: toolu_01D7AfWz12QrAu4LG9do88cZ)
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01D7AfWz12QrAu4LG9do88cZ) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01D7AfWz12QrAu4LG9do88cZ) - dict input keys: ['category', 'name', 'period', 'value', 'unit']
INFO:utils.tool_processing:Processing generate_financial_metric (ID: toolu_01D7AfWz12QrAu4LG9do88cZ) - input type: <class 'dict'>
INFO:utils.tool_processing:Successfully processed financial metric: MMDA to Total Deposits Ratio
INFO:pdf_processing.api_service:Streaming visualization analysis turn 4/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_comparative_period', 'generate_financial_metric', 'generate_table_data', 'generate_graph_data'} with 1945 tokens (haiku_calls=1, sonnet_calls=4)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 7184 (Custom estimate: 251)
INFO:pdf_processing.api_service:Throttling based on token count: 7184 (SDK count: 7184, Custom estimate: 251)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Raw tool input from Claude for generate_financial_metric: type=<class 'dict'>
INFO:pdf_processing.api_service:Received 1 tool calls from streaming response
INFO:pdf_processing.api_service:Tool call: generate_financial_metric (ID: toolu_01QEr7Pihacuas5z1RZUvwbP)
INFO:pdf_processing.api_service:Processing streaming tool generate_financial_metric (ID: toolu_01QEr7Pihacuas5z1RZUvwbP)
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01QEr7Pihacuas5z1RZUvwbP) - input type: <class 'dict'>
INFO:pdf_processing.api_service:Tool generate_financial_metric (ID: toolu_01QEr7Pihacuas5z1RZUvwbP) - dict input keys: ['category', 'name', 'period', 'value', 'unit']
INFO:utils.tool_processing:Processing generate_financial_metric (ID: toolu_01QEr7Pihacuas5z1RZUvwbP) - input type: <class 'dict'>
INFO:utils.tool_processing:Successfully processed financial metric: Non-interest DDA to Total Deposits Ratio
INFO:pdf_processing.api_service:Streaming visualization analysis turn 5/5
INFO:pdf_processing.model_router:Using Sonnet for tools {'generate_comparative_period', 'generate_financial_metric', 'generate_table_data', 'generate_graph_data'} with 2062 tokens (haiku_calls=1, sonnet_calls=5)
INFO:pdf_processing.api_service:Executing tool interaction turn with model_router selected model: claude-3-5-sonnet-20241022, 4 tools available, streaming: True
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (streaming): 7387 (Custom estimate: 251)
INFO:pdf_processing.api_service:Throttling based on token count: 7387 (SDK count: 7387, Custom estimate: 251)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (3 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (37 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (55 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (78 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (115 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (141 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (180 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (191 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (213 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (245 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (264 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (272 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (280 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (307 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (334 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (372 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (410 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (447 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (459 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (479 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (507 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (525 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (540 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (575 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (593 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (618 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (653 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (703 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (744 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (794 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (837 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (870 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (899 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (929 chars)
INFO:services.conversation_service:PROTECTING initial content - ignoring tool-generated content update (939 chars)
INFO:pdf_processing.api_service:Turn 5: Adding new content (939 chars)
INFO:pdf_processing.api_service:Streaming visualization analysis completed: no more tools
INFO:pdf_processing.api_service:Streaming visualization analysis completed: 1 charts, 1 tables, 2 metrics. Analysis text length: 1774
INFO:services.conversation_service:Current assistant message content length: 115
INFO:services.conversation_service:Analysis text length: 1774
INFO:services.conversation_service:Initial content established: True
INFO:services.conversation_service:PROTECTING preserved initial content (115 chars) - ignoring post-tool analysis
INFO:repositories.conversation_repository:Updated and re-fetched message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Preserved initial streaming content without post-tool modifications
INFO:services.conversation_service:Sent message_update event for 45873c30-ca55-4e05-b180-a3c84e49da07 after streaming complete
INFO:services.conversation_service:DEBUG: result.get('metrics'): [{'category': 'Deposits', 'name': 'MMDA to Total Deposits Ratio', 'period': '2025Q1', 'value': 32.3, 'unit': '%', 'isEstimated': False}, {'category': 'Deposits', 'name': 'Non-interest DDA to Total Deposits Ratio', 'period': '2025Q1', 'value': 26.6, 'unit': '%', 'isEstimated': False}]
INFO:services.conversation_service:DEBUG: accumulated_metrics: [{'category': 'Deposits', 'name': 'MMDA to Total Deposits Ratio', 'period': '2025Q1', 'value': 32.3, 'unit': '%', 'isEstimated': False}, {'category': 'Deposits', 'name': 'Non-interest DDA to Total Deposits Ratio', 'period': '2025Q1', 'value': 26.6, 'unit': '%', 'isEstimated': False}]
INFO:services.conversation_service:Processing visualizations for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3: charts=1, tables=1, metrics=2
INFO:services.conversation_service:Processing chart: Deposit Mix Composition Over Time
INFO:services.conversation_service:Processing table: Deposit Mix Analysis
INFO:services.conversation_service:Processing metric: MMDA to Total Deposits Ratio
INFO:services.conversation_service:Processing metric: Non-interest DDA to Total Deposits Ratio
INFO:services.conversation_service:Storing 4 analysis blocks for streaming message 45873c30-ca55-4e05-b180-a3c84e49da07
INFO:services.conversation_service:Refreshed streaming assistant_message 45873c30-ca55-4e05-b180-a3c84e49da07 to load analysis_blocks
INFO:services.conversation_service:Sending message_complete event for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3 after analysis blocks stored
INFO:services.conversation_service:message_complete event sent for conversation 51be33e8-f07d-4c4a-a089-3a90c74959e3 after analysis blocks
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:     127.0.0.1:63337 - "GET /api/conversation/message/45873c30-ca55-4e05-b180-a3c84e49da07 HTTP/1.1" 200 OK
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:services.conversation_service:Found ANTHROPIC_API_KEY in environment variables: sk-ant-a...TQAA
INFO:pdf_processing.api_service:ClaudeService initialized with model: claude-3-5-sonnet-20241022, PDF support, timeout=90s, max_retries=5, headers: {'anthropic-beta': 'token-efficient-tools-2025-02-19,files-api-2025-04-14,fine-grained-tool-streaming-2025-05-14'}
INFO:pdf_processing.langgraph_service:LangGraphService initialized with model: claude-3-5-sonnet-20241022
INFO:pdf_processing.api_service:LangGraph service successfully initialized
INFO:pdf_processing.api_service:Sending request to Claude API with 1 messages, streaming: False
INFO:pdf_processing.api_service:Sending request to Claude API with 1 messages, streaming: False
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (generate_response non-streaming): 260
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (generate_response non-streaming): 260
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 260 (Custom estimate: 266)
INFO:pdf_processing.api_service:Throttling based on token count: 260 (SDK count: 260, Custom estimate: 266)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages/count_tokens "HTTP/1.1 200 OK"
INFO:pdf_processing.api_service:Anthropic SDK estimated input tokens (non-streaming): 260 (Custom estimate: 266)
INFO:pdf_processing.api_service:Throttling based on token count: 260 (SDK count: 260, Custom estimate: 266)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:     127.0.0.1:63337 - "POST /api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/generate-followups?limit=3 HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:     127.0.0.1:63338 - "POST /api/conversation/51be33e8-f07d-4c4a-a089-3a90c74959e3/generate-followups?limit=3 HTTP/1.1" 200 OK
</Backend_Logs>